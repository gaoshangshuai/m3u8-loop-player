<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>HLS增强播放器</title>
    <style>
        #videoWrapper {
            position: relative;
            max-width: 800px;
            margin: 20px auto;
        }
        #statusBar {
            padding: 10px;
            background: #f0f0f0;
            color: #333;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="videoWrapper">
        <video id="hlsVideo" controls playsinline></video>
        <div id="statusBar">状态: 初始化中...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <script>
        const initPlayer = () => {
            const video = document.getElementById('hlsVideo');
            const statusBar = document.getElementById('statusBar');
            const m3u8Url='https://bp-resource-cc.bestv.cn/material/8e9fd77cb864f2dd5e70d093a4bba368/2020/0910/video/c6380e3edf53450f802166b9b6e75a20.m3u8'; // 替换为你的地址

            // 增强配置
            const hlsConfig = {
                xhrSetup: function(xhr, url) {
                    // 强制携带跨域凭证（需服务器配合）
                    xhr.withCredentials = true;
                },
                debug: true,
                enableWorker: true,
                lowLatencyMode: true,
                backBufferLength: 30
            };

            // 错误处理增强
            const handleError = (errorType, errorDetails) => {
                statusBar.innerHTML = `错误: ${errorType} | ${errorDetails}`;
                console.error('[HLS Error]', errorType, errorDetails);
            };

            if (Hls.isSupported()) {
                const hls = new Hls(hlsConfig);
                
                // 绑定事件监听器
                hls.on(Hls.Events.MEDIA_ATTACHED, () => {
                    statusBar.innerHTML = '状态: 媒体加载中...';
                    hls.loadSource(m3u8Url);
                });

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    statusBar.innerHTML = '状态: 准备就绪';
                    video.play().catch(err => {
                        statusBar.innerHTML = '状态: 需要用户点击播放';
                    });
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                handleError('网络错误', `尝试重新连接... (${data.details})`);
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                handleError('媒体错误', '尝试恢复播放...');
                                hls.recoverMediaError();
                                break;
                            default:
                                hls.destroy();
                                handleError('致命错误', '需要重新初始化');
                                initPlayer(); // 重新初始化
                        }
                    }
                });

                hls.attachMedia(video);
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari原生支持
                video.src = m3u8Url;
                video.addEventListener('loadedmetadata', () => {
                    video.play();
                });
            }
        };

        // 初始化播放器
        initPlayer();
    </script>
</body>
</html>
